<?php

use Drupal\Core\Form\FormStateInterface;

function pennchas_form_alter_form_alter(array &$form, FormStateInterface $form_state, string $form_id)
{
    if ($form_id === 'user_role_form' || $form_id === 'group_role_add_form' || $form_id === 'group_role_edit_form') {
        pennchas_form_alter_role_form($form, $form_state);
    }
}

function pennchas_form_alter_entity_bundle_field_info_alter(&$fields, $entity_type, $bundle)
{
    if ($bundle === 'reserve_room') {
        if (isset($fields['field_room'])) {
            $fields['field_room']->addConstraint('AllowRoomConstraint');
        }

        if (isset($fields['field_event_schedule'])) {
            $fields['field_event_schedule']->addConstraint('RoomAvailableConstraint');
        }
    }
}

function pennchas_form_alter_role_form(array &$form, FormStateInterface $form_state)
{
    $categories = [];
    $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree('role_category');
    if (!empty($terms)) {
        foreach ($terms as $term) {
            $categories[$term->tid] = $term->name;
        }

        $role = $form_state->getFormObject()->getEntity();
        $existing_categories = $role->getThirdPartySetting('umbera_roles', 'target_ids');

        $form['umbera_roles'] = [
            '#type' => 'checkboxes',
            '#title' => t('Umbera Roles'),
            '#default_value' => $existing_categories ?: '',
            '#options' => $categories,
        ];

        if ($form['actions']) {
            foreach (array_keys($form['actions']) as $action) {
                if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
                    $form['actions'][$action]['#submit'][] = 'role_form_submit_handler';
                }
            }
        }
    }
}

function role_form_submit_handler(&$form, FormStateInterface $form_state)
{
    $role_categories = $form_state->getValue('umbera_roles');
    $role_categories = array_filter($role_categories);
    $role = $form_state->getFormObject()->getEntity();
    $role->setThirdPartySetting('umbera_roles', 'target_ids', $role_categories);
    $role->save();
}
