<?php

use Drupal\Core\Block\BlockPluginInterface;
use Drupal\Core\Config\Entity\Query\Query;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\views\Plugin\views\query\Sql;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_page_attachments().
 */
function view_alteration_page_attachments(array &$attachments)
{
    // Attach the custom JavaScript file for AJAX Views pager.
    $attachments['#attached']['library'][] = 'view_alteration/ajax_pager';
}

/**
 * Implements hook_theme().
 */
function view_alteration_theme()
{
    return [
        'ajax_pager' => [
            'version' => '1.0',
            'js' => [
                'js/ajax_pager.js',
            ],
        ],
    ];
}


/**
 * Add the logged in user allowed groups in the query.
 * 
 * Implements hook_views_query_alter().
 */
function view_alteration_views_query_alter(ViewExecutable $view, Sql $query)
{
    $viewId = $view->id();
    static $reportViewIds = [
        'moderation_reports' =>  1,
        'rooms_reservation_moderation_reports' =>  1,
        'contents_change_report' =>  1,
        'contents_delete_report' =>  1,
        'events_evaluation_report' =>  1,
        'room_reservation_reports' =>  1,
        'users_reports' =>  1,
        'videos_link_report' =>  1
    ];
    if (isset($reportViewIds[$viewId])) {
        view_alteration_handle_reports_view($query, $viewId);
        return;
    }

    if ($viewId === 'media_library') {
        view_alteration_apply_group_filter_to_query($query, ['gcfd.gid', 'group_relationship_field_data_media_field_data.gid']);
    }
}

function view_alteration_handle_reports_view(Sql &$query, string $viewId)
{
    $groupRelationshipColumn = [
        'users_reports' => 'group_relationship_field_data_users_field_data.gid',
        'videos_link_report' => 'group_relationship_field_data_media_field_data.gid',
    ];

    $field = $groupRelationshipColumn[$viewId] ?? 'gcfd.gid';
    view_alteration_apply_group_filter_to_query($query, [$field]);
}

function view_alteration_apply_group_filter_to_query(Sql &$query, array $fields)
{
    $groups = \Drupal::service('pennchas_common.option_group')->options('house1', false);
    if ($groups && $fields) {
        foreach ($fields as $field) {
            $query->addWhere(0, $field, array_keys($groups), 'IN');
        }
    }
}
